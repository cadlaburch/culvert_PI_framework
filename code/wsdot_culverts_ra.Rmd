---
title: "wsdot_culvert_ra"
author: "Connor Lewis-Smith"
date: "12/30/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Prepare environment ----
rm(list = ls())
# Load libraries
library(sf)
library(spData)
library(ggsn)
library(maps)
library(ggmap)
library(raster)
library(tidyverse)
library(here)
library(janitor)
library(tmap)
library(nhdplusTools)
library(patchwork)

library(shiny)
library(DT)
library(sf)
library(readxl)
library(rgdal)
library(leaflet)
library(lubridate)
library(ineq)
library(classInt)
library(viridis)
library(stargazer)
```

## WSDOT Project

This code is a template for matching site ids from WDFW with other organizations data for comparison. 

Here we use data scrapped from WSDOT's pdf tables outlining their culvert improvement projects to match with WDFW's Fish Passage Inventory data. WSDOT's project list can be found in the Google drive. 


```{r, include=FALSE}

# ____ WDFW inventory ----
if(!file.exists(here("data/culv_inventories/WdfwFishPassage.zip"))){
  download.file(
    "https://fortress.wa.gov/dfw/public/PublicDownload/habitat/FishPassage/WdfwFishPassage.zip",
    here("data/culv_inventories/WdfwFishPassage.zip")
  )
  unzip(
    here("data/culv_inventories/WdfwFishPassage.zip"),
    exdir = here("data/culv_inventories/WdfwFishPassage")
  )
}

st_layers(here("data/culv_inventories/WdfwFishPassage/WdfwFishPassage.gdb"))
sf_allculv_wdfw <- st_read(here("data/culv_inventories/WdfwFishPassage/WdfwFishPassage.gdb"), layer = "WDFW_FishPassageSite")

# Repair names
sf_allculv_wdfw <- sf_allculv_wdfw %>% clean_names()

# Check some key variables
sf_allculv_wdfw %>% tabyl(feature_type)

sf_allculv_wdfw %>% filter(str_detect(feature_type, "Culvert")) %>% tabyl(fish_passage_feature_type_code) # Codes needed (1 = culvert, 2 = non-culvert xing, 3 = dam, 4 = other, 5 = natural barrier)
sf_allculv_wdfw %>% filter(str_detect(feature_type, "Culvert")) %>% tabyl(fish_passage_barrier_status_code) # Codes needed (0 = NA, 10 = Barrier, 20 = Not a barrier, 99 = Unknown)
sf_allculv_wdfw %>% tabyl(percent_fish_passable_code) # Codes needed (0 = NA, 10 = 0, 20 = 33, 30 = 66, 40 = 100, 99 = Unknown)
sf_allculv_wdfw %>% tabyl(owner_type_code) # Codes needed (1 = "city", 2 = "county", 3 = 

```

## Plot WSDOT Culvert Improvement Projects

Here you can see the locations of WSDOT culvert improvement projects. 

```{r, echo=FALSE}

# Explore with county outlines
counties <- read_sf(here("data", "cb_2018_us_county_5m", "cb_2018_us_county_5m.shp"))

counties = counties %>% 
  filter(STATEFP == "53") %>% 
  mutate(GEOID = as.numeric(GEOID)) %>% 
  rename(COUNTY = GEOID)

wa.plot <- ggplot() +
  geom_sf(data = counties)

# Case area borders
sf_case <- st_read(here("data/WSDOT_-_Fish_Passage_US_v._WA_Case_Area_Boundary-shp/WSDOT_-_Fish_Passage_US_v._WA_Case_Area_Boundary.shp"), quiet = TRUE)

# Must set CRS as well as save for spatial clipping
sf_case <- st_transform(sf_case, crs = 4326)
sf_allculv_wdfw <- st_transform(sf_allculv_wdfw, crs = 4326)

# explore WSDOT projects and their prioritization

sf_allculv_wdfw$site_id <- gsub(' +',' ',sf_allculv_wdfw$site_id)

wsdot_projects <- read_csv(here("data", "WSDOT_projects", "wsdot_projects.csv"))

wsdot_projects = wsdot_projects %>% 
  rename(site_id = 'Site Id')

`%!in%` <- Negate(`%in%`)
 
wsdot_projects.2 <- subset(wsdot_projects, site_id %in% sf_allculv_wdfw$site_id)

wsdot_projects.3 <- subset(wsdot_projects, site_id %!in% sf_allculv_wdfw$site_id) #all in dataset

wsdot_projects.2 = wsdot_projects.2 %>% 
  merge(sf_allculv_wdfw)

wsdot_projects.sf = wsdot_projects.2 %>% 
  st_as_sf() 

wsdot_projects.sf <- st_transform(wsdot_projects.sf, crs = 4326)

wa.plot.case.1 <- ggplot() +
  geom_sf(data = counties) +
  geom_sf(data = sf_case, aes(fill = .5),
          alpha = .2) +
  geom_sf(data = wsdot_projects.sf) +
  labs(title = "WSDOT Projects State Wide") +
  theme_void()
wa.plot.case.1
```

## WDFW Priority Scores of WSDOT Projects

Below shows the WDFW PI scores for WSDOT projects. This suggests that WSDOT is not only using PI to inform project selection. The project name category from WDFW is also shown below to suggest that WSDOT projects can be collaborations, which then take different names as seen below. 



```{r, include=TRUE}
hist(wsdot_projects.2$priority_index_total_quantity, 
     xlab = "priority score",
     main = "wsdot project priority score hist") 
```

## How does WDFW catagorize WSDOT Projects?

The project name category from WDFW is shown below to suggest that WSDOT projects can be collaborations, which then take different names as seen below. 

```{r, include=TRUE}
project.count = wsdot_projects.2 %>%  
  group_by(project_name) %>% 
  mutate(culvert_count = n())

ggplot(project.count, aes(x = reorder(project_name, culvert_count), y = culvert_count)) + 
  geom_point()  +
  coord_flip() +
  ylab("project count") +
  xlab("")


```



