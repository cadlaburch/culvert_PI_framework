---
title: "WDFW Fish Passage Inventory Explore"
author: "Connor Lewis-Smith & Catalina Burch"
date: "12/27/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Prepare environment ----
rm(list = ls())
# Load libraries
library(sf)
library(maps)
library(ggmap)
library(raster)
library(tidyverse)
library(here)
library(janitor)
library(tmap)
library(nhdplusTools)
library(patchwork)
library(DT)
library(dplyr)
library(tidyverse)
library(readxl)
library(ggplot2)
library(ineq)
library(classInt)

```

## Getting to Know the WDFW Fish Passage Inventory Data 

In this markdown, we introduce and explore the WDFW fish passage data. More information from the WDFW can be found at this link: (https://wdfw.wa.gov/species-habitats/habitat-recovery/fish-passage/assessment). Since the data is being updated by WDFW on a rolling basis, this document should be ran after re-downloading the zip file to display the most up to date information. This process does take time to download, so only re-pull the zip when necessary. The "if" statement below is used to prevent re-downloading the zip file for every run.

The first chunk of code was primarily written by Braeden and copied into this markdown by Connor, the following chunks where used to explore the data set during Connor's RAship in the Fall of 2021. 

Below provides an introduction to the Fish Passage Inventory data set broadly. This includes displaying the Coordinate Reference System, along with the variable names, and some basic summary statistics. 


```{r WDFW}

# ____ WDFW inventory ----
if(!file.exists(here("data/culv_inventories/WdfwFishPassage.zip"))){
  download.file(
    "https://fortress.wa.gov/dfw/public/PublicDownload/habitat/FishPassage/WdfwFishPassage.zip",
    here("data/culv_inventories/WdfwFishPassage.zip")
  )
  unzip(
    here("data/culv_inventories/WdfwFishPassage.zip"),
    exdir = here("data/culv_inventories/WdfwFishPassage")
  )
}

st_layers(here("data/culv_inventories/WdfwFishPassage/WdfwFishPassage.gdb"))
sf_allculv_wdfw <- st_read(here("data/culv_inventories/WdfwFishPassage/WdfwFishPassage.gdb"), layer = "WDFW_FishPassageSite")

# Check projection
st_crs(sf_allculv_wdfw)

# Check variable names
names(sf_allculv_wdfw)

# Repair names
sf_allculv_wdfw <- sf_allculv_wdfw %>% clean_names()
names(sf_allculv_wdfw)
# Lots of variables look like they're codes, will need to find codebook
# Currently building custom codebook using https://geodataservices.wdfw.wa.gov/hp/fishpassage/index.html

# Check some key variables
sf_allculv_wdfw %>% tabyl(feature_type)
# Lots of culverts! Over 35k!
summary(sf_allculv_wdfw$lineal_gain_measurement)
# Big distribution of lineal gain, though unclear how this is calculated; appears to be in meters
sf_allculv_wdfw %>% filter(str_detect(feature_type, "Culvert")) %>% tabyl(fish_passage_feature_type_code) # Codes needed (1 = culvert, 2 = non-culvert xing, 3 = dam, 4 = other, 5 = natural barrier)
sf_allculv_wdfw %>% filter(str_detect(feature_type, "Culvert")) %>% tabyl(fish_passage_barrier_status_code) # Codes needed (0 = NA, 10 = Barrier, 20 = Not a barrier, 99 = Unknown)
sf_allculv_wdfw %>% tabyl(percent_fish_passable_code) # Codes needed (0 = NA, 10 = 0, 20 = 33, 30 = 66, 40 = 100, 99 = Unknown)
sf_allculv_wdfw %>% tabyl(owner_type_code) # Codes needed (1 = "city", 2 = "county", 3 = "federal", 4 = "private", 5 = "state", 6 = "tribal", 7 = "other", 8 = "port", 9 = "drainage district, 11 = "irrigation district", 12 = "unknown")

#sf_allculv_wdfw %>% tabyl(potential_species) # Presented as list of potential species, will need to be separated with stringr tools

#sf_allculv_wdfw %>% tabyl(fish_use_code) # Codes needed (0 = NA, 10 = Yes, 20 = No, 99 = Unknown)

#sf_allculv_wdfw %>% tabyl(significant_reach_code) # Codes needed (0 = NA, 10 = Yes, 20 = No, 99 = Unknown)

#sf_allculv_wdfw %>% tabyl(case_area_flag) # No values

# Lots of codes, will probably need to request a code book from WDFW

```

## Injunction Area Fish Barrier Culverts

The next step for exploring the data is to spatially clip it to the injunction area of interest. More information on the injunction area and its history are in the Google drive. Here we also apply names to decode some of the variables of interest. Since we are concerned with fish barrier culverts, anything that is not a culvert or a barrier is filtered from the data. Below we see the remaining barrier types along with a map and a plot of passablility and count by county.

```{r, echo=FALSE}
# Case area borders
sf_case <- st_read(here("data/WSDOT_-_Fish_Passage_US_v._WA_Case_Area_Boundary-shp/WSDOT_-_Fish_Passage_US_v._WA_Case_Area_Boundary.shp"), quiet = TRUE)

# Must set CRS as well as save for spatial clipping
sf_case <- st_transform(sf_case, crs = 4326)
sf_allculv_wdfw <- st_transform(sf_allculv_wdfw, crs = 4326)

# Clip culvert dataset by case area
sf_case_culverts <- sf_allculv_wdfw[sf_case, ] 
  
sf_case_culverts = sf_case_culverts %>% 
  filter(grepl('Culvert', feature_type)) %>% 
  filter(!grepl('Non', feature_type)) ### Change to Contains culters

# Decode coded section based on cross reference
sf_case_culverts = sf_case_culverts %>% 
  mutate(fish_passage_barrier_status_code = as.factor(case_when(
    fish_passage_barrier_status_code == 0 ~ "NA",
    fish_passage_barrier_status_code == 10 ~ "barrier",
    fish_passage_barrier_status_code == 20 ~ "non-barrier",
    fish_passage_barrier_status_code == 99 ~ "unknown"
    ))) %>% 
  mutate(percent_fish_passable_code = as.factor(case_when(
    percent_fish_passable_code == 0 ~ "NA",
    percent_fish_passable_code == 10 ~ "0",
    percent_fish_passable_code == 20 ~ "33",
    percent_fish_passable_code == 30 ~ "66",
    percent_fish_passable_code == 40 ~ "100",
    percent_fish_passable_code == 99 ~ "unkown"
  ))) %>% 
  mutate(owner_type_code = as.factor(case_when(
    owner_type_code == 1 ~ "city",
    owner_type_code == 2 ~ "county",
    owner_type_code == 3 ~ "federal",
    owner_type_code == 4 ~ "private",
    owner_type_code == 5 ~ "state",
    owner_type_code == 6 ~ "tribal",
    owner_type_code == 7 ~ "other",
    owner_type_code == 8 ~ "port",
    owner_type_code == 9 ~ "drainage district",
    owner_type_code == 11 ~ "irrigation district",
    owner_type_code == 12 ~ "unknown"
  ))) %>% 
  mutate(fish_use_code = as.factor(case_when(
    fish_use_code == 0 ~ "NA", #Think we should keep NAs?
    fish_use_code == 10 ~ "yes",
    fish_use_code == 20 ~ "no",
    fish_use_code == 99 ~ "unknown"
  ))) %>% 
  mutate(significant_reach_code = as.factor(case_when(
    significant_reach_code == 0 ~ "NA",
    significant_reach_code == 10 ~ "yes",
    significant_reach_code == 20 ~ "no",
    significant_reach_code == 99 ~ "unknown"
  )))
 
# Filter out non barrier culverts  
sf_case_culverts = sf_case_culverts %>% 
  filter(percent_fish_passable_code != "100") %>% 
  filter(fish_use_code != "no") %>% 
  filter(fish_passage_barrier_status_code != "non-barrier") 

# How many barrier culverts in the injunction area?
nrow(sf_case_culverts)

# What are the remaining feature types?
print(unique(sf_case_culverts$feature_type)) 

# What are the remaining fish passable codes?
print(unique(sf_case_culverts$percent_fish_passable_code))

# Create map of injunction area over counties
counties <- read_sf(here("data", "cb_2018_us_county_5m", "cb_2018_us_county_5m.shp"))

counties = counties %>% 
  filter(STATEFP == "53") %>% 
  mutate(GEOID = as.numeric(GEOID)) %>% 
  rename(COUNTY = GEOID)

wa.plot <- ggplot() +
  geom_sf(data = counties) +
  geom_sf(data = sf_case,
          aes(color = "red", alpha = 0.5)) +
  labs(title = "Injunction area overlayed on counties") +
  theme_void()

wa.plot

# Find percent passable counts at county level
count_passability = sf_case_culverts %>% 
  group_by(county_name, percent_fish_passable_code) %>% 
  mutate(count_passable = n()) %>% 
  dplyr::select(county_name, percent_fish_passable_code, count_passable) %>% 
  st_drop_geometry() %>% 
  unique()

count_passability$percent_fish_passable_code <- as.factor(count_passability$percent_fish_passable_code)

# Graph percent passable counts at county level
ggplot(count_passability, aes(fill = percent_fish_passable_code,
                             y = count_passable, x = reorder(county_name, count_passable))) +
  geom_bar(position="stack", stat="identity") +
  xlab("") +
  ylab("Fish Barrier Culvert Count") + 
  guides(fill=guide_legend(title= "Percent Passable")) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```


The following chunk of code is work by Catalina to calculate some summary statistics using the WDFW database
```{r, include=FALSE}
#I did this in base R, but I probably should have done it in tidy. I learned both and I'm still figuring out when to use each.
mean(sf_case_culverts$priority_index_total_quantity, na.rm=TRUE) #answer 13.1
median(sf_case_culverts$priority_index_total_quantity, na.rm=TRUE) #answer 11
range(sf_case_culverts$priority_index_total_quantity, na.rm=TRUE) #answer 0, 82
sd(sf_case_culverts$priority_index_total_quantity, na.rm=TRUE) #answer 8.6
shapiro.test(sf_case_culverts$priority_index_total_quantity) #p<2.2e-16 not normal
IQR(sf_case_culverts$priority_index_total_quantity, na.rm=TRUE) #IQR = 10.11

sf_case_culverts %>% 
  ggplot(aes(x=priority_index_total_quantity))+
  geom_histogram()+
  theme_minimal()

ggsave("wdfw_PI_dist.png")

#I want to do the same with lineal gain but there are some high scoring lineal gain rows that are NA's in the PI column
sf_case_culverts %>% 
  drop_na(priority_index_total_quantity)->
  CatData

mean(CatData$lineal_gain_measurement, na.rm=TRUE) #answer 1721
median(CatData$lineal_gain_measurement, na.rm=TRUE) #answer 790
range(CatData$lineal_gain_measurement, na.rm=TRUE) #answer 0, 72607
sd(CatData$lineal_gain_measurement, na.rm=TRUE) #answer 3232

sf_case_culverts %>% 
  ggplot(aes(x=lineal_gain_measurement))+
  geom_histogram()+
  theme_minimal()

#Catalina: I would also like to know how many barrier culverts are in the case area that have a WDFW score
  #I believe the answer is 4259 because in my dataframe CatData I ommited N/A scores
```

## Injunction Area Fish Barrier Culverts Priority Index Scores

The WDFW data set includes priority scores using their PI. Information on their PI can be found in the Google drive and in their handbook. The PI score is only provided for a fraction of the culverts in the case area. Below is a histogram for the scores for the entire data set along with the case area. The locations of scored and un-scored culverts are also displayed below. The top number also shows the number of fish barrier culverts in the case area.   


```{r, echo=TRUE}
# Hist of WDFW Scores, whole data set and injunction area

hist(sf_allculv_wdfw$priority_index_total_quantity,
     main = "",
     xlab = "All barriers WDFW priority scores")

hist(sf_case_culverts$priority_index_total_quantity,
     main = "",
     xlab = "case area fish barrier culverts WDFW priority scores")

# Plot PI scored and un-scored culverts 
whole.count = sf_case_culverts %>%  
  mutate(culvert_count = n())

whole.count$recieved_priority = ifelse(is.na(whole.count$priority_index_total_quantity), 0, 1)

whole.count =whole.count %>% 
  mutate(percent_scored = mean(recieved_priority))

priotizied = whole.count %>% 
  filter(recieved_priority == 1) 

wa.plot.case <- ggplot() +
  geom_sf(data = counties) +
  geom_sf(data = sf_case,
          alpha = .5) +
  geom_sf(data = whole.count, aes(color = factor(recieved_priority))) +
  theme_void()
wa.plot.case 

```

## Injunction Area Fish Barrier Culverts (Median Survey Age by County)

Here we explore the median year of the last survey by county for fish barrier culverts within the injunction area. Quantiles are used to help visualize the data in this choropleth map. Other variables could be explored using this same approach.   


```{r, echo=FALSE}
# explore dates by county

sf_case_culverts$survey_date_year <- as.numeric(str_sub(sf_case_culverts$survey_date, -4))

counties = counties %>% 
  rename(county_name = NAME)

data_age = sf_case_culverts %>% 
  st_drop_geometry() %>% 
  as.data.frame() %>% 
  dplyr::select(county_name, survey_date_year) %>% 
  drop_na() %>% 
  group_by(county_name) %>%
  mutate(county_median_data_age = (median(survey_date_year))) %>% 
  dplyr::select(county_name, county_median_data_age) %>% 
  unique() 

data_age = counties %>% 
  merge(data_age)

breaks_qt <- classIntervals(c(min(data_age$county_median_data_age) - .00001, data_age$county_median_data_age), n = 5, style = "jenks")

data_age <- mutate(data_age, median_age_cut = cut(county_median_data_age, breaks_qt$brks)) 


ggplot(data_age) + 
  geom_sf(aes(fill = median_age_cut)) +
  scale_fill_brewer(palette = "Blues") +
  theme_void() +
  guides(fill=guide_legend(title= "Median Year of Last Survey Jenks")) +
  labs(title = "WDFW Fish Barrier Culvert Median Year of Last Survey by County")

```


## Culvert Count and Road Miles Comparison along with PI percentage

Here we explore the count of fish barrier culverts by county and it is related to road miles. Centerline road miles per county was pulled from WSDOT at (https://www.wsdot.wa.gov/mapsdata/travel/hpms/annualmileage.htm). The code provides a template for comparing culvert count with other county level variables of interest. The code also contains how to extract the percentage of the culverts by county that have a PI score compared to those that do not in the WDFW data set. As you can see, a majority of culverts do not have PI scores. 


```{r, echo=TRUE}
 
# Get culvert count 
sf_case_culverts.count = sf_case_culverts %>%  
  group_by(county_name) %>% 
  mutate(culvert_count = n()) 

# Plot culvert count 
ggplot(sf_case_culverts.count, aes(x = reorder(county_name, culvert_count), y = culvert_count)) + 
  geom_point()  +
  coord_flip() +
  ylab("Number of Culverts") +
  xlab("") 

# Get percentage of culverts with PI score by county
sf_case_culverts.count$recieved_priority = ifelse(is.na(sf_case_culverts.count$priority_index_total_quantity), 0, 1)

sf_case_culverts.count = sf_case_culverts.count %>% 
  group_by(county_name) %>% 
  mutate(percent_scored = mean(recieved_priority)*100)

# Load county centerline miles 
centerline_miles <- read_excel(here("data", "DVMT2020COrpt.xlsx"),
                    sheet = "centerline_miles")

sf_case_culverts.count = sf_case_culverts.count %>% 
  merge(centerline_miles)

culvert_by_milage = sf_case_culverts.count %>% 
  select(c(county_name, culvert_count, centerline_miles, percent_scored)) %>% 
  st_drop_geometry() %>% 
  unique() %>% 
  mutate(barrier_per_mile = culvert_count / centerline_miles)

# Create plot showing culvert per mile and percent with scores per county
ggplot(culvert_by_milage, aes(fill = percent_scored,
                              y = barrier_per_mile, x = reorder(county_name, barrier_per_mile))) +
  geom_bar(position="stack", stat="identity") +
  xlab("") +
  ylab("Fish Barrier Culvert Per Centerline Miles") + 
  guides(fill=guide_legend(title= "Percent with Scores")) + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

# Explore relationship between percent of culverts with score and road miles
ggplot(culvert_by_milage, aes(x = barrier_per_mile, y = percent_scored)) + 
  geom_point() 

# Map Fish Barrier Culvert by Mile per County
counties <- read_sf(here("data", "cb_2018_us_county_5m", "cb_2018_us_county_5m.shp"))
counties = counties %>% 
  rename(county_name = NAME) %>% 
  filter(STATEFP == "53")

counties <- subset(counties, county_name %in% culvert_by_milage$county_name)

culvert_by_milage =  counties %>% 
  merge(culvert_by_milage) 

# Fish Barrier Culverts per Road Mile breaks and map
breaks_qt <- classIntervals(c(min(culvert_by_milage$barrier_per_mile) - .00001, culvert_by_milage$barrier_per_mile), n = 5, style = "quantile")

culvert_by_milage <- mutate(culvert_by_milage, barrier_per_mile_cut = cut(barrier_per_mile, breaks_qt$brks)) 

ggplot(culvert_by_milage) + 
  geom_sf(aes(fill =  barrier_per_mile_cut)) +
  scale_fill_brewer(palette = "YlGn") +
  theme_void() +
  guides(fill=guide_legend(title= "Culverts per Road Mile Quantile Breaks")) +
  labs(title = "WDFW Fish Barrier Culverts per Centerline Road Mile by County")


```

## Gini Coefficient and Standard Dev. of Prioritization Scores by County

Here we explore the PI scores in this data set a bit further. The below code looks at the prioritization scores from the WDFW data set in terms of the Gini coefficient and the standard dev. The Gini coefficients are plotted by county and this, along with standard deviation of the PI, is then displayed in a table as well as on a map using Jenks breaks.


```{r, echo=FALSE}

# Make list of counties names
county.names <- unique(sf_case_culverts$county_name)

gini_stdev_function <- function(x){
  df = sf_case_culverts %>% 
    filter(county_name == as.character(x)) %>% 
    dplyr::select(county_name, priority_index_total_quantity) %>% 
    st_drop_geometry() %>% 
    drop_na() %>% 
    mutate(score_stdev = sd(priority_index_total_quantity))
  
  vec.1 <- df$priority_index_total_quantity
  
  gini_coeff <- ineq(vec.1, type = "Gini")
 # plot(Lc(vec.1))
  
  df2 = df %>% 
    dplyr::select(county_name, score_stdev) %>% 
    unique() %>% 
    mutate(gini_coefficient = (gini_coeff))
  
  return(df2)
}

# Loop for finding gini coefficient of portfolio risk by county
datalist = list()
for (i in county.names){
  new <- gini_stdev_function(i)
  datalist[[i]] <- new
}

county_gini = do.call(rbind, datalist)


ggplot(county_gini, aes(y = gini_coefficient, x = reorder(county_name, gini_coefficient))) +
  geom_bar(position="stack", stat="identity") +
  xlab("") +
  ylab("Fish Barrier Culvert Priority Score Gini Coefficient") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

row.names(county_gini) <- NULL

county_gini.2 = county_gini %>% 
  rename('County' = county_name) %>% 
  rename('PI Score Standard Dev.' = score_stdev) %>% 
  rename('PI Score Gini Coefficient' = gini_coefficient)

print(county_gini.2)

# Prepare maps
counties <- read_sf(here("data", "cb_2018_us_county_5m", "cb_2018_us_county_5m.shp"))
counties = counties %>% 
  rename(county_name = NAME) %>% 
  filter(STATEFP == "53")

counties <- subset(counties, county_name %in% county_gini$county_name)

# Gini Coeff. breaks and map
county_gini.sf = counties %>% 
  merge(county_gini) 

# Standard Dev. breaks and map
breaks_qt <- classIntervals(c(min(county_gini.sf$score_stdev) - .00001, county_gini.sf$score_stdev), n = 5, style = "jenks")

county_gini.sf <- mutate(county_gini.sf, score_stdev_cut = cut(score_stdev, breaks_qt$brks)) 

ggplot(county_gini.sf) + 
  geom_sf(aes(fill =  score_stdev_cut)) +
  scale_fill_brewer(palette = "OrRd") +
  theme_void() +
  guides(fill=guide_legend(title= "St. Dev Jenks Breaks")) +
  labs(title = "WDFW Fish Barrier Culvert Prioritization Scores' Standard Dev. by County")

# Gini Coeff. breaks and map 
breaks_qt <- classIntervals(c(min(county_gini.sf$gini_coefficient) - .00001, county_gini.sf$gini_coefficient), n = 5, style = "jenks")

county_gini.sf <- mutate(county_gini.sf, gini_coefficient_cut = cut(gini_coefficient, breaks_qt$brks)) 

ggplot(county_gini.sf) + 
  geom_sf(aes(fill = gini_coefficient_cut)) +
  scale_fill_brewer(palette = "OrRd") +
  theme_void() +
  guides(fill=guide_legend(title= "PI Gini Ratio Quantiles")) +
  labs(title = "WDFW Fish Barrier Culvert Prioritization Scores' Gini Ratio by County")

```



